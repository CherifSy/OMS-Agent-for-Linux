FROM centos:6
MAINTAINER Abderrahmane Benbachir abderb@microsoft.com

# Important for unittests
RUN adduser omsagent
RUN groupadd omiusers

RUN mkdir -p /home/scratch

RUN yum install -y centos-release-scl yum-utils && yum-config-manager --enable rhel-server-rhscl-7-rpms

# Extra repos & dependencies
RUN yum update -y && yum install -y epel-release

RUN yum install -y which wget sudo make tree autoconf vim cmake zip git redhat-lsb \
    openssh-clients bind-utils bison gcc-c++ libcxx libstdc++-static rpm-devel \
    pam-devel openssl-devel rpm-build mysql-devel curl-devel selinux-policy-devel \
    audit-libs-devel boost148-devel jemalloc-devel lsof net-tools patch curl tar bzip2 unzip \
    && yum clean all

# Devtoolset-7 (gcc 7.x)
RUN yum install -y devtoolset-7-toolchain
ENV PATH /opt/rh/devtoolset-7/root/usr/bin:$PATH

# Ruby 2.4
ADD https://cache.ruby-lang.org/pub/ruby/2.4/ruby-2.4.4.tar.gz /home/scratch/ruby-2.4.4.tar.gz
RUN cd /home/scratch && tar -zxf ruby-2.4.4.tar.gz
RUN cd /home/scratch/ruby-2.4.4 && ./configure && make && make install

# OpenSSL
RUN mkdir -p /home/scratch/ostc-openssl
RUN mkdir -p ~/.ssh/ && ssh-keyscan github.com >> ~/.ssh/known_hosts
RUN git clone --branch OpenSSL_1_0_0-stable  https://github.com/openssl/openssl.git /home/scratch/ostc-openssl/openssl-1.0.0
RUN git clone --branch OpenSSL_1_1_0-stable  https://github.com/openssl/openssl.git /home/scratch/ostc-openssl/openssl-1.1.0
# Build OpenSSL
RUN cd /home/scratch/ostc-openssl/openssl-1.0.0 && ./config --prefix=/usr/local_ssl_1.0.0 shared -no-ssl2 -no-ec -no-ec2m -no-ecdh && make depend && make && make install_sw
RUN cd /home/scratch/ostc-openssl/openssl-1.1.0 && ./config --prefix=/usr/local_ssl_1.1.0 shared -no-ssl2 -no-ec -no-ec2m -no-ecdh && make depend && make && make install_sw

